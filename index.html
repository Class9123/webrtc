<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>WebRTC 1</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
</head>
<body>
    <div id="intro-container">
        <h2>WebRTC, Passing SDP with no signaling.</h2>
        <img width="100%" src="WebRTC SDP Gif.gif"/>
        <p><b>Instructions: </b>Start by opening two tabs side by side and follow the steps below to pass SDP offer and answer. I will refer to each tab as <i><b>User 1</b></i> and <i><b>User 2</b></i>.</p>
        <a href="https://github.com/divanov11/WebRTC-Simple-SDP-Handshake-Demo/" target="_blank"><b>Source Code</b></a>
    </div>

    <div id="videos">
        <video class="video-player" id="user-video" autoplay playsinline></video>
    </div>

    <div class="step">
        <p><strong>Step 1:</strong> User 1, click "Create offer" to generate SDP offer and copy offer from text area below.</p>
        <button id="create-offer">Create Offer</button>
    </div>

    <label>SDP OFFER:</label>
    <textarea id="offer-sdp" placeholder='User 2, paste SDP offer here...'></textarea>

    <div class="step">
        <p><strong>Step 2:</strong> User 2, paste SDP offer generated by user 1 into text area above, then click "Create Answer" to generate SDP answer and copy the answer from the text area below.</p>
        <button id="create-answer">Create answer</button>
    </div>

    <label>SDP Answer:</label>
    <textarea id="answer-sdp" placeholder="User 1, paste SDP answer here..."></textarea>

    <div class="step">
        <p><strong>Step 3:</strong> User 1, paste SDP answer generated by user 2 into text area above and then click "Add Answer"</p>
        <button id="add-answer">Add answer</button>
    </div>

<script>
let peerConnection = new RTCPeerConnection();
let localStream;
let remoteStream;

let init = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
        remoteStream = new MediaStream();
        document.getElementById('user-video').srcObject = localStream;

        localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = (event) => {
            event.streams[0].getTracks().forEach((track) => {
                remoteStream.addTrack(track);
            });
            document.getElementById('user-video').srcObject = remoteStream;
        };
    } catch (error) {
        console.error('Error accessing media devices.', error);
    }
};

let createOffer = async () => {
    try {
        peerConnection.onicecandidate = async (event) => {
            if(event.candidate){
                document.getElementById('offer-sdp').value = JSON.stringify(peerConnection.localDescription);
            }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
    } catch (error) {
        console.error('Error creating offer.', error);
    }
};

let createAnswer = async () => {
    try {
        let offer = JSON.parse(document.getElementById('offer-sdp').value);

        peerConnection.onicecandidate = async (event) => {
            if(event.candidate){
                document.getElementById('answer-sdp').value = JSON.stringify(peerConnection.localDescription);
            }
        };

        await peerConnection.setRemoteDescription(offer);

        let answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer); 
    } catch (error) {
        console.error('Error creating answer.', error);
    }
};

let addAnswer = async () => {
    try {
        let answer = JSON.parse(document.getElementById('answer-sdp').value);
        if (!peerConnection.currentRemoteDescription){
            await peerConnection.setRemoteDescription(answer);
        }
    } catch (error) {
        console.error('Error adding answer.', error);
    }
};

init();

document.getElementById('create-offer').addEventListener('click', createOffer);
document.getElementById('create-answer').addEventListener('click', createAnswer);
document.getElementById('add-answer').addEventListener('click', addAnswer);
</script>
</body>
</html>
